{"blocks":[{"type":"codeTool","data":{"codeData":{"value":"viewof button = Inputs.button(\"Refresh\", {\n  reduce: () => {\n    actions.variable(actions.types.REFRESH_GRAPH, [], () => {\n      return window.graphxrApi;\n    });\n  },\n})","pinCode":false,"dname":"a2c934c4-3320-4285-bd07-8e0210c1f496","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"viewof neo4jCondition = render(({ useSetter }) => {\n  const [neo4jCategory, setNeo4jCategory] = useState(labels[0]);\n  const [properties, setProperties] = useState(propertiesMap[neo4jCategory]);\n  const [neo4jProperty, setNeo4jProperty] = useState(properties[0]);\n  if (!neo4jCategory) {\n    return jsx`<div>loading...</div>`;\n  }\n  useSetter({ neo4jCategory, neo4jProperty });\n  return jsx`<div className=\"d-flex flex-wrap align-items-center flex-gap\">\n    <form className=\"oi-3a86ea\">\n      <label>Neo4j  Category</label>\n      <select className=\"oi-3a86ea-input\" value='${neo4jCategory}' \n      onChange=${(e) => {\n        let neo4jCategoryTmp = e.target.value;\n        setNeo4jCategory(neo4jCategoryTmp);\n        setProperties(propertiesMap[neo4jCategoryTmp]);\n        setNeo4jProperty(propertiesMap[neo4jCategoryTmp][0]);\n      }}>\n      ${_.map(labels, (label) => {\n        return jsx`<option key='${label}' value='${label}'>${label}</option>`;\n      })}\n    \t</select>\n    </form>\n    <form className=\"oi-3a86ea\">\n      <label>Neo4j Property</label>\n      <select className=\"oi-3a86ea-input\" value='${neo4jProperty}' \n      onChange=${(e) => setNeo4jProperty(e.target.value)}>\n      ${_.map(properties, (label) => {\n        return jsx`<option key='${label}' value='${label}'>${label}</option>`;\n      })}\n    \t</select>\n    </form>\n    \n  </div>`;\n})","pinCode":false,"dname":"b06d0e50-4a1d-4227-b5ac-5b7a1b70df02","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"viewof conditions = render(({ useSetter }) => {\n  const [count, setCount] = useState(_graph ? 1 : 1);\n  const [arr, setArr] = useState(\n    _.map(Array(count), () => {\n      return {id:uuid.v4()};\n    })\n  );\n  useSetter({ arr });\n  return jsx`<div className=\"d-flex flex-column flex-gap\">\n      ${_.map(arr, (obj, index) => {\n        return jsx`<div className=\"d-flex  flex-wrap\" key=${obj.id}>\n        <${CsvComponent} index=${index} id=${obj.id} useSetter=${(obj) => {\n          arr[index] = obj;\n          setArr(arr);\n        }} />\n        <button className=\"btn-danger text-danger\" onClick=${(e) => {\n          let arrT = _.clone(arr);\n          arrT.splice(index, 1);\n          setArr(arrT);\n        }}>Remove</button>\n        </div>`;\n      })}\n      <div className=\"d-flex flex-row flex-gap\">\n          <button className=\"btn-default\" onClick=${(e) => {\n            let arrT = _.reduce(\n              arr,\n              (p, o, i) => {\n                if (\n                  _.keys(o).length >1 &&\n                  ~categoriesExceptLabels.indexOf(o.csvCategory)\n                ) {\n                  p.push(o);\n                }\n                return p;\n              },\n              []\n            );\n            if (arrT.length > 0) {\n              arrT.splice(arrT.length - 1, 0, {id:uuid.v4()});\n            } else {\n              arrT.push({id:uuid.v4()});\n            }\n            setArr(arrT);\n          }}>Add Condition</button>\n          <!--<button className=\"btn-primary\" onClick={}>Run</button>-->\n      </div>\n    </div>`;\n})","pinCode":false,"dname":"e7ff0e0f-6dd3-463c-9bf7-d7c19117f2c2","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"render(({}) => {\n  return jsx`<button className=\"btn-primary\" onClick=${(e) => {\n    if (!cypher) {\n      return;\n    }\n    gxr.neo4j(cypher).then(()=>{\n      setTimeout(genRelations, 1500);\n    });\n  }}>Run To Render graph</button>`;\n})","pinCode":false,"dname":"8c8870ed-9d29-4505-97cd-93c0765fc6bf","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"queryResult = {\n  if (!cypher) {\n    return undefined;\n  }\n  try {\n    let res = await gxr.neo4j(cypher, { saveToGraph: false });\n    let arr = res._content.data;\n    return arr;\n  } catch (e) {\n    throw  new Error(e);\n  }\n}","pinCode":false,"dname":"5c17ff7f-e9a8-4d6c-956a-965f379f997b","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"cypher = {\n  const { neo4jCategory, neo4jProperty } = neo4jCondition;\n  if (\n    conditions.arr.length === 0 ||\n    _.filter(conditions.arr, (o) => {\n      return _.keys(o).length === 1;\n    }).length > 0\n  ) {\n    return \"\";\n  }\n  return (\n    _.reduce(\n      conditions.arr,\n      (p, cond, index) => {\n        const {\n          logic,\n          propertyValueType,\n          matching,\n          csvCategory,\n          csvProperty,\n          csvPropertyValue,\n          ignoreCase,\n        } = cond;\n        if (index) {\n          p += logic;\n        }\n        if (propertyValueType === \"string\") {\n          p += ` ${\n            ignoreCase ? `tolower(n.${neo4jProperty})` : `n.${neo4jProperty}`\n          } ${matchingsMap[propertyValueType][matching]} ${\n            ignoreCase\n              ? `tolower('${csvPropertyValue}')`\n              : `'${csvPropertyValue}'`\n          }\\n`;\n        } else {\n          p += ` ${`n.${neo4jProperty}`} ${\n            matchingsMap[propertyValueType][matching]\n          } ${csvPropertyValue}\\n`;\n        }\n        return p;\n      },\n      `MATCH (n:${neo4jCategory}) \nWHERE `\n    ) + \" RETURN n\"\n  );\n}","pinCode":false,"dname":"e45c5770-b02a-45a4-a860-c80d00f96a11","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"neo4jCondition","pinCode":false,"dname":"0828307c-6ed6-488b-9416-f137b83ef0f8","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"conditions.arr","pinCode":false,"dname":"8e41c692-5940-4ea9-8ffb-728b81d50008","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"genRelations = function () {\n  if (!queryResult || !queryResult.nodes || queryResult.nodes.length == 0) {\n    return;\n  }\n  let sourceNodes = _.map(queryResult.nodes, (n) => {\n    let source = _.filter(_graph.nodes, (nn) => {\n      return nn.id === n.id;\n    })[0];\n    return source;\n  });\n  let conds = conditions.arr;\n  for (let i = 0; i < conds.length; i++) {\n    let condition = conds[i];\n    const { logic, csvPropertyType, matching, ignoreCase } = condition;\n    let targetNodes = condition.csvNodes;\n    for (let j = 0; j < sourceNodes.length; j++) {\n      let source = sourceNodes[j];\n      if (!source) {\n        continue;\n      }\n      for (let k = 0; k < targetNodes.length; k++) {\n        let target = targetNodes[k];\n        if (source && target) {\n          _graph.addEdge(\n            source,\n            target,\n            _.assign({ name: \"LINK_TO\" }, { properties:{ logic, csvPropertyType, matching, ignoreCase } })\n          );\n        }\n      }\n    }\n  }\n}","pinCode":false,"dname":"f4916fbe-2d7b-4ed3-a092-03c06bbf81d2","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"viewof select_labels=Inputs.table(Lables, {required:false})","pinCode":false,"dname":"ae400ebd-4105-4518-ace2-4a2df8c9df68","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"Inputs.button(`Pull ${select_labels.map(l=>l.label)}`,{\n  reduce: async ()=>{\n    const whereClause = select_labels\n      .map(l=>l.label)\n      .map(label => `n:${label}`).join(' OR ');\n    const query =`match (n) WHERE ${whereClause} RETURN n`\n    console.log(query)\n    await gxr.neo4j(query)\n  }, \n  disabled:select_labels.length==0\n})","pinCode":false,"dname":"d3b6cdf9-37d5-44d5-aebc-c578f69924e1","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"Relationships = {\n  let res = await gxr.neo4j(`MATCH ()-[r]->()\nRETURN type(r) AS relationshipType, count(r) as cnt\n`, {saveToGraph: false})\n  let arr= res.data\n  arr.shift()\n  return arr.map(elem=>({relationship:elem[0], count:elem[1].low}))\n}","pinCode":false,"dname":"4e069fe1-15a1-450b-b57f-c81a880d5ece","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"viewof relationships = Inputs.table(Relationships, { required: false })","pinCode":false,"dname":"f0fea07d-9714-4ac0-bad8-1de26be6a201","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"Inputs.button(`Pull ${relationships.map(r=>r.relationship)}`, {\n  reduce: async ()=>{\n    const whereClause = relationships\n      .map(l=>l.relationship)\n      .map(rel => `r:${rel}`).join(' OR ');\n    const query =`match (n)-[r]->(m) WHERE ${whereClause} RETURN *`\n    console.log(query)\n    await gxr.neo4j(query)\n  },\n  disabled: relationships.length==0\n})","pinCode":false,"dname":"e3e4d67e-0787-4d9e-8d78-280b6fbfde5b","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"matchingsMap = {\n  return {\n    string: { equal: \"=\", contains: \"CONTAINS\", in: \"IN\" },\n    number: { \"=\": \"=\",\"<>\": \"<>\", \"<\": \"<\", \"<=\": \"<=\" },\n  };\n}","pinCode":false,"dname":"0a2da308-0816-4a69-9ee0-9bd03e5ec3f9","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"logics = [\"AND\", \"OR\"]","pinCode":false,"dname":"cc2ad9de-4295-4597-925f-29be831149df","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"function getValueType(values) {\n  let maxs = { string: 0, number: 0 };\n  _.each(values, (value) => {\n    if (~[\"number\", \"string\"].indexOf(typeof value)) {\n      maxs[typeof value]++;\n    }\n  });\n  return maxs.string > maxs.number ? \"string\" : \"number\";\n}","pinCode":false,"dname":"d8b96f24-4db9-4e0c-833e-e685ee014c81","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"CsvComponent = component(({ index, id, useSetter }) => {\n  const [logic, setLogic] = useState(logics[0]);\n  const [csvCategory, setCsvCategory] = useState(categoriesExceptLabels[0]);\n  if (!csvCategory) {\n    return jsx`<div>There is no category that's not belong to Neo4j can be selected.</div>`;\n  }\n  const [csvProperties, setCsvProperties] = useState(\n    csvPropertiesMap[csvCategory]\n  );\n  const [csvProperty, setCsvProperty] = useState(csvProperties[0]);\n  const [ignoreCase, setIgnoreCase] = useState(true);\n  let nodes = _.filter(_graph_nodes, (n) => n.data.detail.type === csvCategory);\n  let csvPropertyValuesTmp = _.uniq(\n    nodes.map((n) => {\n      return n.data.detail.data[csvProperty];\n    })\n  );\n  const [csvPropertyValues, setCsvPropertyValues] = useState(\n    csvPropertyValuesTmp\n  );\n  const [csvPropertyValue, setCsvPropertyValue] = useState(\n    csvPropertyValues[0]\n  );\n  const [csvNodes, setCsvNodes] = useState(\n    _.filter(nodes, (n) => {\n      return n.data.detail.data[csvProperty] === csvPropertyValue;\n    })\n  );\n  const [propertyValueType, setPropertyValueType] = useState(\n    getValueType(csvPropertyValues)\n  );\n  const [matching, setMatching] = useState(\n    _.keys(matchingsMap[propertyValueType])[0]\n  );\n  useSetter({\n    id,\n    logic,\n    propertyValueType,\n    matching,\n    csvCategory,\n    csvProperty,\n    csvPropertyValue,\n    csvNodes,\n    ignoreCase,\n  });\n  let radioFunc = (e) => {};\n  return jsx`<div className=\"d-flex flex-wrap align-items-center flex-gap\">\n  ${\n    !!index &&\n    jsx`<div class=\"d-flex align-items-center flex-gap\">\n        <label>Logic</label>\n        ${_.map(logics, (L, I) => {\n          return jsx`<label key=${I}><input type=\"radio\" name=${\n            \"radio_input\" + index\n          } value=\"${L}\" checked=${logic == L}\n         onChange=${(e) => {\n           setLogic(e.target.value);\n         }}/>${L}</label>`;\n        })}\n    </div>`\n  }\n   <div className=\"d-flex align-items-center flex-gap\">\n      <label>Matching</label>\n      <select className=\"oi-3a86ea-input\" value='${matching}' \n      onChange=${(e) => setMatching(e.target.value)}>\n      ${_.map(_.keys(matchingsMap[propertyValueType]), (label) => {\n        return jsx`<option key='${label}' value='${label}'>${label}</option>`;\n      })}\n    \t</select>\n    </div>\n    <div className=\"d-flex align-items-center flex-gap\">\n      <label>CSV  Category</label>\n      <select className=\"oi-3a86ea-input\" value='${csvCategory}' \n      onChange=${(e) => {\n        let csvCategoryTmp = e.target.value;\n        setCsvCategory(csvCategoryTmp);\n        setCsvProperties(csvPropertiesMap[csvCategoryTmp]);\n        let csvPropertyTmp = csvPropertiesMap[csvCategoryTmp][0];\n        setCsvProperty(csvPropertyTmp);\n        nodes = _.filter(\n          _graph_nodes,\n          (n) => n.data.detail.type === csvCategoryTmp\n        );\n        let csvPropertyValuesTmp = _.uniq(\n          nodes.map((n) => {\n            return n.data.detail.data[csvPropertyTmp];\n          })\n        );\n        setCsvPropertyValues(csvPropertyValuesTmp);\n        setCsvPropertyValue(csvPropertyValuesTmp[0]);\n        setCsvNodes(\n          _.filter(nodes, (n) => {\n            return (\n              n.data.detail.data[csvPropertyTmp] === csvPropertyValuesTmp[0]\n            );\n          })\n        );\n        let propertyValueTypeTmp = getValueType(csvPropertyValuesTmp);\n        setPropertyValueType(propertyValueTypeTmp);\n        setMatching(_.keys(matchingsMap[propertyValueTypeTmp])[0]);\n      }}>\n      ${_.map(categoriesExceptLabels, (label) => {\n        return jsx`<option key='${label}' value='${label}'>${label}</option>`;\n      })}\n    \t</select>\n    </div>\n    <div className=\"d-flex align-items-center flex-gap\">\n      <label>CSV Property</label>\n      <select className=\"oi-3a86ea-input\" value='${csvProperty}' \n      onChange=${(e) => {\n        let csvPropertyTmp = e.target.value;\n        setCsvProperty(csvPropertyTmp);\n        nodes = _.filter(\n          _graph_nodes,\n          (n) => n.data.detail.type === csvCategory\n        );\n        let csvPropertyValuesTmp = _.uniq(\n          nodes.map((n) => {\n            return n.data.detail.data[csvPropertyTmp];\n          })\n        );\n        setCsvPropertyValues(csvPropertyValuesTmp);\n        setCsvPropertyValue(csvPropertyValuesTmp[0]);\n        setCsvNodes(\n          _.filter(nodes, (n) => {\n            return (\n              n.data.detail.data[csvPropertyTmp] === csvPropertyValuesTmp[0]\n            );\n          })\n        );\n        let propertyValueTypeTmp = getValueType(csvPropertyValuesTmp);\n        setPropertyValueType(propertyValueTypeTmp);\n        setMatching(_.keys(matchingsMap[propertyValueTypeTmp])[0]);\n      }}>\n      ${_.map(csvProperties, (label) => {\n        return jsx`<option key='${label}' value='${label}'>${label}</option>`;\n      })}\n    \t</select>\n    </div>\n    <div className=\"d-flex align-items-center flex-gap\">\n      <label>CSV Property Value</label>\n      <select className=\"oi-3a86ea-input\" value='${csvPropertyValue}' \n      onChange=${(e) => {\n        let csvPropertyValueTmp =\n          propertyValueType === \"string\" ? e.target.value : +e.target.value;\n        setCsvPropertyValue(csvPropertyValueTmp);\n        setCsvNodes(\n          _.filter(nodes, (n) => {\n            return n.data.detail.data[csvProperty] === csvPropertyValueTmp;\n          })\n        );\n      }}>\n      ${_.map(csvPropertyValues, (label) => {\n        return jsx`<option key='${label}' value='${label}'>${label}</option>`;\n      })}\n    \t</select>\n    </div>\n    <div>${csvNodes.length} nodes</div>\n    <div className=\"d-flex align-items-center flex-gap ${\n      propertyValueType === \"string\" ? \"\" : \"hide\"\n    }\">\n    \t<label>Ignore Case</label>\n        <input className=\"oi-3a86ea-input\" type=\"checkbox\" checked=${ignoreCase}\n        onChange=${(e) => {\n          setIgnoreCase(e.target.checked);\n        }} />\n    </div>\n  </div>`;\n})","pinCode":false,"dname":"2c86e237-6510-43f6-bf8a-1b899b489e39","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"_graph.nodes","pinCode":true,"dname":"058a1c42-a4fc-4c9c-912d-cfbd21702844","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"_graph_nodes = {\n  let selectedNodes = _.filter(\n    _graph.nodes,\n    (n) => n.selected && !~labels.indexOf(n.data.detail.type)\n  );\n  return selectedNodes.length\n    ? selectedNodes\n    : _.filter(_graph.nodes, (n) => !~labels.indexOf(n.data.detail.type));\n}","pinCode":false,"dname":"2f5c8c24-f496-4e4c-b141-e1f3fb5a0561","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"categoriesExceptLabels = {\n  return _.uniq(_graph_nodes.map((n) => n.data.detail.type));\n}","pinCode":false,"dname":"fd706709-e3ac-4335-9591-dccaadc54ded","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"labels = _.reduce(\n  Lables,\n  (prev, L) => {\n    prev.push(L.label);\n    return prev;\n  },\n  []\n)","pinCode":false,"dname":"30e5f391-93da-4f46-9c56-c01a93307cfc","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"Lables = {\n  let res = await gxr.neo4j(\n    `MATCH (n)\nRETURN labels(n) AS label, count(n) as cnt`,\n    { saveToGraph: false }\n  );\n  let arr = res._content.data;\n  arr.shift();\n  return arr.map((elem) => ({ label: elem[0][0], count: elem[1].low }));\n}","pinCode":false,"dname":"0401a2ca-a521-43e9-bed9-2252c7213d80","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"refreshGraphElement = html`<div>refresh</div>`","pinCode":false,"dname":"d84e4140-beb0-41b1-942d-0efadb746d97","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"_graph = Generators.observe((next) => {\n  // Yield the input’s initial value.\n  next( window.opener._drawing.graph);\n  // Define an event listener to yield the input’s next value.\n  const refresh_graph = () => next( window.opener._drawing.graph);\n  actions.inspector(\n    refreshGraphElement,\n    [actions.types.REFRESH_GRAPH],\n    refresh_graph\n  )// When the generator is disposed, detach the event listener.\n  return () => {\n    actions.deleteCache(refreshGraphElement);\n    console.log(\"remove refresh graph listener\");\n  };\n})","pinCode":false,"dname":"629ceebf-2325-4bc0-b8d0-e618d8ccde06","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"---","pinCode":false,"dname":"d5ccb3e9-d626-45d2-a9e7-d46968a2194c","codeMode":"markdown","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"csvPropertiesMap = {\n  let promiseMap = {};\n  _.map(_graph_nodes, (n) => {\n    let type = n.data.detail.type;\n    if (!~labels.indexOf(type)) {\n      if (!promiseMap[type]) {\n        promiseMap[type] = {};\n      }\n      _.each(n.data.detail.data, (value, key) => {\n        if (undefined === promiseMap[type][key]) {\n          promiseMap[type][key] = value;\n        }\n      });\n    }\n  });\n  return _.reduce(promiseMap,(prev,obj,k)=>{\n    prev[k]=_.keys(obj);\n    return prev;\n  },{});\n}","pinCode":false,"dname":"191eab01-8aee-4f85-9a5a-518b2bb8604d","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"propertiesMap= {\n  let promiseMap= {};\n  for(let i =0;i<labels.length;i++){\n     let res = await gxr.neo4j(`MATCH (p:${labels[i]})  RETURN keys(p);`, {\n      saveToGraph: false,\n    });\n    let arr = res._content.data;\n    promiseMap[labels[i]]= Array.from(\n      _.reduce(\n        arr.slice(1),\n        (p, o) => {\n          _.each(o[0], (v) => {\n            p.add(v);\n          });\n          return p;\n        },\n        new Set()\n      )\n    );\n  }\n  return promiseMap;\n}","pinCode":false,"dname":"3cb7dfbd-26f8-4ec3-8c51-16ca2c2b9322","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"import { jsx, render, useState, component } from '1_graphxr/react/react';","pinCode":false,"dname":"9f08c2f0-d5c4-4cc2-b1cf-dd5e8c3e7f4c","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"html`<style>\n  .codex-editor{\n   font-size:1.2em\n  }\n   label{\n   white-space: pre!important;\n  }\n  label {\n    margin-bottom: unset;\n}\n</style>`","pinCode":false,"dname":"a4d7331b-e9d3-4981-b95c-4be865f3223f","codeMode":"javascript2","hide":true}}},{"type":"codeTool","data":{"codeData":{"value":"uuid = import('https://cdn.skypack.dev/uuid@8.3.2?min')","pinCode":false,"dname":"883a0866-deca-4ad4-8f52-7bdab3b4d1e4","codeMode":"javascript2"}}}],"version":"2.19.1"}