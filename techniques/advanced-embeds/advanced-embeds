{"blocks":[{"type":"codeTool","data":{"codeData":{"value":"md`# Advanced embedding and downloading`","pinCode":false,"dname":"af126ba7-eec3-44c5-b689-004bf4dbf50c","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"intro = (md`So, you’ve written your magnum opus: a notebook full of splendor and delight. Maybe you’ve embedded it on your blog for all to see. Now, the problem is — How do you integrate its nifty charts into your web app? How do you save it to your hard drive, to file away for posterity alongside your old Word documents and vacation photos?`)","pinCode":false,"dname":"d212132d-fa6e-4154-881e-3de37c9efd6e","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`As you’ve probably noticed by now, Observable notebooks are a little different than the regular old JavaScripts you know and love. They execute in order of [data flow](/@observablehq/how-observable-runs) rather than in a linear sequence of statements, and contain strange and marvelous reactive primitives, like ${Link(\"tutorial/introduction-to-views/introduction-to-views\",\"viewof\")} and ${Link(\"tutorial/introduction-to-mutable-state/introduction-to-mutable-state\", \"mutable\")}.`","pinCode":false,"dname":"fb5551d3-fdce-4ba5-a774-2b28ecaa1714","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Luckily, Observable provides an [open-source runtime](https://github.com/observablehq/runtime) which stitches together a notebook’s cells into a dependency graph and brings them to life through evaluation; a [standard library](https://github.com/observablehq/stdlib), which provides helpful functions for working with HTML, SVG, generators, files and promises among [other useful sundries](/@observablehq/standard-library); and an [inspector](https://github.com/observablehq/inspector), which implements the default strategy for rendering DOM and JavaScript values into a live web page — although you’re free to write your own.`","pinCode":false,"dname":"ce4c54bd-a2a9-4232-8295-a8a01ed55c8c","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`## Embedding a cell on a web page\n\nIn the [introduction to embedding](/@observablehq/embeds), you saw how named cells from any published or shared notebook — a chart, a visualization, a widget — are quick and easy to embed.`","pinCode":false,"dname":"37a0eb7f-f360-4108-9389-3d66cd3aabd3","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Click **Embed** in the menu to the left of the cell below to open the Embed tool. The default Iframe method is fairly self-contained; this time, select **Runtime with JavaScript** from the dropdown so we can dive into it.`","pinCode":false,"dname":"1064a4a7-8ab3-4ced-af62-f0993f9fafa7","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"graphic = (htl.html`<svg width=100 height=100>\n  <circle cx=40 cy=40 r=40 fill=green style=\"opacity: 0.25;\" /> \n  <circle cx=50 cy=50 r=40 fill=red style=\"opacity: 0.25;\" />  \n  <circle cx=60 cy=60 r=40 fill=blue style=\"opacity: 0.25;\" /> \n</svg>`)","pinCode":false,"dname":"63ac3250-30fe-41a8-9bdf-e851d51f1427","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`By default, the embed code loads the latest published version of the notebook. When you publish a new version of the notebook on Observable, your embedded cells will update immediately (or at least, within 30 seconds).`","pinCode":false,"dname":"18f38506-5291-4f44-a24c-5089f696d139","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`If you want to lock your embed code to a specific published version, you can add \\`@version\\` to your notebook’s ES module URL — and you can always find specific published versions [in your notebook history](/@observablehq/history).`","pinCode":false,"dname":"bd465942-288f-4e6a-98df-083cb739c5e1","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Here’s a link to [a plain web page that embeds the \\\\\\`graphic\\\\\\` cell above](https://observablehq.github.io/examples/versioning/), from two different versions of this notebook, hosted off-site.`","pinCode":false,"dname":"8761a028-640c-4421-97c6-f0edeb264634","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`## Notebooks as ES modules\n\nYour notebook can be compiled and downloaded as a [JavaScript module](https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/)! Click **Download code** in the notebook menu to download your compiled notebook, including the Observable runtime, any imported notebooks, and an HTML template to demonstrate how to run your notebook.\n\n<img width=\"239\" alt=\"Screen Shot 2019-09-18 at 9 38 27 AM\" src=\"${await FileAttachment(\"new.png\").url()}\">`","pinCode":false,"dname":"e743866a-dd91-491a-a42a-ebee11a6573b","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Alternatively, you can “hot link” your code directly from Observable, as long as you’ve published your notebook or enabled link sharing:\n\n~~~\nhttps://api.observablehq.com/@jashkenas/my-neat-notebook.js?v=3\n~~~`","pinCode":false,"dname":"eae89620-dae8-46a8-bb9f-369cd04781ef","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`You can use this module to run your notebook in any JavaScript environment. In this form, notebooks are true JavaScript programs that you can manipulate and integrate deeply with your application. Now let’s explore some ways to use embedded notebooks!`","pinCode":false,"dname":"f6055239-6ca7-41d5-aca4-813230cdde57","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`## Rendering cells\n\nThe most obvious way to embed a notebook is to display its contents, live, in a web page. For this, the Observable runtime includes a [standard inspector](https://github.com/observablehq/inspector); it takes live values from the notebook and puts them into your HTML where you want them. For example, here’s an expanded view of the code the Embed tool gives you to render a notebook into an empty body ([see it live](https://bl.ocks.org/mbostock/raw/1cf3e863b054aca0bc7061b5292120ab/)):\n\n~~~html\n<!DOCTYPE html>\n<body>\n<script type=\"module\">\n\n// Load the Observable runtime and inspector.\nimport {Runtime, Inspector} from \"https://cdn.jsdelivr.net/npm/@observablehq/runtime@4/dist/runtime.js\";\n\n// Your notebook, compiled as an ES module.\nimport notebook from \"https://api.observablehq.com/@jashkenas/my-neat-notebook.js?v=3\";\n\n// Load the notebook, observing its cells with a default Inspector\n// that simply renders the value of each cell into the provided DOM node.\nnew Runtime().module(notebook, Inspector.into(document.body));\n\n</script>\n~~~`","pinCode":false,"dname":"76923f13-5b9a-40b8-8b8d-b2297d1c0663","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`The inspector doesn’t include any inline styles, but there is a [default stylesheet](https://cdn.jsdelivr.net/npm/@observablehq/inspector@3/dist/inspector.css) ([see source](https://github.com/observablehq/inspector/blob/master/src/style.css)) if you want it. To make your embedded notebook beautiful, try a CSS framework. We favor [Tachyons](http://tachyons.io/) here at Observable, but there are lots of good choices, such as GitHub’s [Primer](https://primer.style/css).`","pinCode":false,"dname":"5b5641a5-0c52-4e82-b129-f571b6703f8e","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`If you don’t want to render the entire notebook, define a custom function to control which cells are rendered and where they go. For example, to render just the cell named “chart” into the DOM element with the same id, say:\n\n~~~js\nnew Runtime().module(notebook, name => {\n  if (name === \"chart\") {\n    return new Inspector(document.querySelector(\"#chart\"));\n  }\n});\n~~~`","pinCode":false,"dname":"97ef98a4-6a11-4b37-ba26-9d621ce90f10","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`It’s important to note that when you render a limited set of cells from your notebook, the cells that aren’t used — or depended on by those that are — won’t be run at all!`","pinCode":false,"dname":"58fdb6d2-8cc9-4e88-8605-fa4da0532f16","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Sometimes a cell that’s not referenced has important side effects, as in the [Sortable Bar Chart](https://observablehq.com/@d3/sortable-bar-chart), where an \\\\\\`update\\\\\\` cell passes data to the chart via a method that mutates the existing DOM element. If you want to run a cell with side effects in the background of your embedded notebook, you can return \\\\\\`true\\\\\\` instead of an inspector for those cells:\n\n~~~js\n(new Runtime).module(define, name => {\n  if (name === \"chart\") return Inspector.into(\".chart\")();\n  if (name === \"update\") return true;\n});\n~~~`","pinCode":false,"dname":"019dac11-717f-451b-9e42-d4d607dab14a","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`The code generated by the Embed tool uses this technique to run any cells that refer to one of the cells you’re embedding. If that’s over-eager, you can delete the line.`","pinCode":false,"dname":"66d4ea93-7910-4825-a65c-32d025df6815","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Note that CSS \\`<style>\\` cells don’t produce their side effects unless they are actually inserted into the DOM; they cannot be silently run in the background, and should instead be interpolated into a displayed HTML cell.`","pinCode":false,"dname":"303514b1-8364-4790-adf6-b2bd3eb24733","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"reading = (md`## Reading cell values\n\nWhile the standard inspector is useful for displaying notebooks as-is, either in whole or in part, Observable notebooks are true reactive programs that you can integrate deeply with vanilla JavaScript via *observers*.`)","pinCode":false,"dname":"2c9d5436-46ef-4bc6-8b2b-683f18802e0a","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`An *observer* is an object that you define and implements optional methods to observe a cell’s live value. These methods are called repeatedly by the runtime as follows:\n\n* *observer*.pending() immediately prior to each evaluation;\n* *observer*.fulfilled(*value*) when evaluation finishes, passing the new *value*; and \n* *observer*.rejected(*error*) if evaluation fails, passing the thrown *error*.`","pinCode":false,"dname":"d753f0a5-06ee-4d6f-9a9d-dc468e0ffcf0","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`For example, here’s an observer that doesn’t touch the DOM, instead logging all evaluation to the console:\n\n~~~js\nnew Runtime().module(notebook, name => {\n  return {\n    pending() { console.log(\\`\\${name} is running…\\`); },\n    fulfilled(value) { console.log(name, value); },\n    rejected(error) { console.error(error); }\n  };\n});\n~~~`","pinCode":false,"dname":"61154476-15c2-4741-8021-ec0d37480a0c","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Below is an observer that listens to the “selection” cell, calling *setSelection* to do something with the new value (say, a [React state hook](https://reactjs.org/docs/hooks-state.html)). This technique could be used with a [brushable scatterplot](/@d3/brushable-scatterplot) to drive your application with the selected data.\n\n~~~js\nnew Runtime().module(notebook, name => {\n  switch (name) {\n    case \"viewof selection\": return new Inspector(container);\n    case \"selection\": return {fulfilled(value) { setSelection(value); }};\n  }\n});\n~~~`","pinCode":false,"dname":"2f923963-ee28-4651-8fd9-843cd9400efe","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Sometimes you just want the current value of a cell. For that, you don’t need a proper *observer*; instead, use [*module*.value](https://github.com/observablehq/runtime/blob/master/README.md#module_value) to get a promise to the current value of the cell with the given name.\n\n~~~js\nconst module = new Runtime().module(notebook);\nconst value = await module.value(\"chart\");\ndocument.querySelector(\"#chart\").appendChild(value);\n~~~`","pinCode":false,"dname":"856ff9b9-1014-410f-840b-7f587b590933","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"redefine = (md`## Overriding cell values\n\nIn addition to observing reactive values, your JavaScript program can assign reactive values, too, allowing bidirectional dataflow. For example, say you have a [bar chart](/@d3/bar-chart), and your application wants to update the displayed data dynamically. First, keep a reference to the main module for your notebook:\n\n~~~js\nconst main = new Runtime().module(notebook, name => {\n  if (name === \"chart\") {\n    return new Inspector(container);\n  }\n});\n~~~`)","pinCode":false,"dname":"f3a8cf57-07a2-427b-b671-a7881d7b0ef3","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Then whenever you want to change the chart’s data, call [*module*.redefine](https://github.com/observablehq/runtime/blob/master/README.md#module_redefine):\n\n~~~js\nmain.redefine(\"data\", newData);\n~~~`","pinCode":false,"dname":"86643649-9051-44fd-975f-12ccc1a24755","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Because Observable uses dataflow, the chart will update automatically in response to the new data, and the inspector will replace the contents of the chart’s *container*. You can pass *module*.redefine a constant value, a function that references other cell values—even a [generator](/@observablehq/introduction-to-generators) function that repeatedly yields values to produce an animation, if you want.`","pinCode":false,"dname":"42197612-d157-45f4-9003-4d2bc1d8d2d2","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Another way to alter the behavior of your running notebook is to override Observable’s [standard library](https://github.com/observablehq/stdlib). These built-in variables are provided to all notebooks. For example, for a fixed width of 640px instead of a responsive width, import [Library](https://github.com/observablehq/runtime/blob/main/README.md#Library), then re-assign the width value:\n\n~~~js\nimport {Runtime, Inspector, Library} from \"https://cdn.jsdelivr.net/npm/@observablehq/runtime@4/dist/runtime.js\";\n\nconst runtime = new Runtime(Object.assign(new Library, {width: 640}));\nconst main = runtime.module(notebook, …);\n~~~`","pinCode":false,"dname":"2be7b271-fd2c-4468-ad1f-346dc7c3aaa6","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`## Notebooks as npm modules\n\nThe tarball you get when you click **Download code** is an installable npm module. If you right-click and copy the link, you’ll get something that looks like this:\n\n~~~\nhttps://api.observablehq.com/@jashkenas/my-neat-notebook.tgz?v=3\n~~~`","pinCode":false,"dname":"86456a77-c8c7-4831-b6b4-26c3dd405685","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Use this URL with **npm** or **Yarn** to install the latest version of your notebook in \\`node_modules\\` under its published name (\\`@jashkenas/my-neat-notebook\\`), along with a copy of the Observable runtime:\n\n~~~sh\nnpm install @observablehq/runtime@4\nnpm install https://api.observablehq.com/@jashkenas/my-neat-notebook.tgz?v=3\n~~~`","pinCode":false,"dname":"7f802e3e-dfdd-48c9-b839-da0824a48368","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Depending on your version of Node, you’ll either need to use Node’s \\`--experimental-modules\\` flag, [esm](https://github.com/standard-things/esm), or your preferred bundler of choice. Note that the contents of this tarball may change over time (either because you republished your notebook, or because of internal changes to the compiled format). Thus, you may instead prefer to commit the source code contents of the download tarball into your repository rather than installing from \\`node_modules.\\``","pinCode":false,"dname":"c87d473a-7978-4a05-90b0-a2ac652adca2","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`## Version pinning\n\nTo pin your notebook to a specific version, find the desired version number in the [history](/@observablehq/history) and add it to the URL. Both the ES module and tarball formats support versioning. For example:\n\n~~~\nhttps://api.observablehq.com/@jashkenas/my-neat-notebook@42.js?v=3\nhttps://api.observablehq.com/@jashkenas/my-neat-notebook@365.tgz?v=3\n~~~`","pinCode":false,"dname":"6b06c4e5-c7f3-437c-ac1f-b3bb5ce52d13","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"demo = (md`## Demos ✨\n\nSee our [repository of examples](https://github.com/observablehq/examples) for a reference set of basic techniques, or read about the runtime [in the context of a React application](https://observablehq.com/@observablehq/how-to-embed-a-notebook-in-a-react-app).`)","pinCode":false,"dname":"ce15e1f7-0e40-4896-ad42-2d74d1d752ae","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`As an fun, off-site example of an embedded notebook in action, see [Breakout!](https://ashkenas.com/breakout) It runs [this notebook](/@jashkenas/breakout), and uses the standard inspector to render the game canvas, the New Game button, the current score, and the high score.\n\n<a href=\"https://ashkenas.com/breakout\"><img src=\"${await FileAttachment(\"breakout.png\").url()}\" style=\"max-width: 400px;\" /></a>`","pinCode":false,"dname":"165490a5-111c-4f1b-bb86-1d7e4aa2b117","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`[This CodePen](https://codepen.io/jashkenas/pen/gzZXPG) embeds a [simple notebook](/@jashkenas/tick) that ticks once a second. [Philippe Rivière](/@fil) wrote [a brief tutorial](https://visionscarto.net/observable-jekyll/) that demonstrates embedding [Tissot’s indicatrix](/@fil/tissots-indicatrix) into a blog. And as an arcane demonstration of the dark arts of recursive embedding, here is [a notebook embedding *itself!*](/@jashkenas/ouroboros-a-notebook-embeds-itself) 🤯`","pinCode":false,"dname":"8b0fafc4-d431-46ad-82c2-6714cfda0470","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"links = (htl.html`<ul style=\"list-style: none; text-align: right; padding: 0; max-width: 640px;\">\n\n<li><a title=\"Introduction\" style=\"display: inline-flex; align-items: center; font: 600 14px var(--sans-serif);\" href=\"/@observablehq/introduction-to-embedding?collection=@observablehq/embedding-notebooks\">Introduction<svg width=\"8\" height=\"16\" fill=\"none\" stroke-width=\"1.8\" style=\"margin-left: 0.25em; padding-top: 0.25em;\"><path d=\"M5.25 11.25L2.75 8.25L5.25 5.25\" stroke=\"currentColor\"></path></svg></a></li>\n\n<li><a title=\"Troubleshooting Embedding\" style=\"display: inline-flex; align-items: center; font: 600 14px var(--sans-serif);\" href=\"/@observablehq/troubleshooting-embedding?collection=@observablehq/embedding-notebooks\">Troubleshooting<svg width=\"8\" height=\"16\" fill=\"none\" stroke-width=\"1.8\" style=\"margin-left: 0.25em; padding-top: 0.25em;\"><path d=\"M2.75 11.25L5.25 8.25L2.75 5.25\" stroke=\"currentColor\"></path></svg></a></li>\n\n</ul>`)","pinCode":false,"dname":"b8e344e6-8f8f-4b8a-8a83-e02ae0828a16","codeMode":"javascript2"}}}],"version":"2.19.1"}