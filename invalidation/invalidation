{"blocks":[{"type":"codeTool","data":{"codeData":{"value":"md`# Invalidation\n\nTo free up resources when a cell is re-evaluated, such as cancelling timers or disposing WebGL contexts, use the \\`invalidation\\` promise from the [standard library](https://observablehq.com/@observablehq/stdlib). This promise resolves when the current cell is re-evaluated: when the cell’s code changes, when it is run using Shift-Enter, or when a referenced input changes.\n\nHere’s \\`invalidation\\` being used to terminate a timer loop:`","pinCode":false,"dname":"932930cd-ae6a-40c1-95b7-87d716473e3a","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"{\n  const div = html`<div>`;\n  let request = requestAnimationFrame(function tick() {\n    div.textContent = Date.now();\n    request = requestAnimationFrame(tick);\n  });\n  invalidation.then(() => cancelAnimationFrame(request));\n  return div;\n}","pinCode":false,"dname":"f80d4453-36df-48db-927f-50d8da7c0412","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`If the cell above didn’t handle invalidation, then the page would get slower each time the cell were re-evaluated because many timer loops would run simultaneously! This is especially noticeable when a cell starting the timer loop references other cells such as sliders.\n\nThe cell above is contrived to demonstrate invalidation. A more idiomatic way of implementing a timer loop in Observable is a generator:`","pinCode":false,"dname":"be05111b-4b0e-4076-9248-512f05c3cdc9","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"{\n  const div = html`<div>`;\n  while (true) {\n    div.textContent = Date.now();\n    yield div;\n  }\n}","pinCode":false,"dname":"779d905b-57c8-4766-942d-325112aea528","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`Or even simpler, use \\`now\\`:`","pinCode":false,"dname":"070c959c-5e21-4f4e-9af3-c8e8c860d3ad","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"html`<div>${now}`","pinCode":false,"dname":"c54f36e2-d61e-4a04-9b81-dc9ed8aabe18","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`You can also implement disposal using a generator: if the generator yields the \\`invalidation\\` promise, it will wait until the cell is re-evaluated, at which point [*generator*.return](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Generator/return) is invoked by the runtime. You can then dispose of the cell’s resources in a try-finally block.`","pinCode":false,"dname":"c389f7fa-765e-43e3-b5a6-ee0330e77281","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"{\n  ++mutable count; // This should always be one.\n  yield mutable count === 1\n      ? html`<div style=\"color:green;\">Success!</div>`\n      : html`<div style=\"color:red;\">Failure!</div>`;\n  try {\n    yield invalidation;\n  } finally {\n    --mutable count;\n  }\n}","pinCode":false,"dname":"bab80e12-169e-463b-91e9-21f12bc8b3b9","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"mutable count = (0)","pinCode":false,"dname":"68de6918-b939-40ff-95e3-0ee0048ea336","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`A generator can implement disposal without the \\`invalidation\\` promise, too, just by implementing *generator*.return. Using Generators.observe, call the *notify* function to yield a value, then return a *finalize* function to dispose of the cell’s resources. The *finalize* function will only be called when the cell is re-evaluated.`","pinCode":false,"dname":"b4edbf17-435b-4476-8ba8-2041c915f9a0","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"Generators.observe(notify => {\n  notify(42);\n  return () => console.log(\"invalidated\");\n})","pinCode":false,"dname":"d7160da6-3ad3-4540-be0d-4c592b5ba037","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"md`You can even implement a generator by hand:`","pinCode":false,"dname":"5d7e596a-5ea6-4acd-bda1-b60be768c792","codeMode":"javascript2"}}},{"type":"codeTool","data":{"codeData":{"value":"{\n  let done = false;\n  return {\n    next() {\n      if (done) return {done: true};\n      done = true;\n      return {done: false, value: 42};\n    },\n    return() {\n      console.log(\"invalidated\");\n    }\n  };\n}","pinCode":false,"dname":"75cfc118-51b6-40d6-a639-f1f989a40f81","codeMode":"javascript2"}}}],"version":"2.19.1"}